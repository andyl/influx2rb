#!/usr/bin/env bash

# bash/setup - setup an influx server
# uses the influx CLI

# ----- setup -----

clear

shopt -s expand_aliases
source ~/.bashrc_code

# ----- private data -----

own_name=$(opx ixowner name)
own_pass=$(opx ixowner pass)
own_tokn=$(opx ixowner tokn)
mgr_name=$(opx ixmanager name)
mgr_pass=$(opx ixmanager pass)
mgr_tokn=$(opx ixmanager tokn)
usr_name=$(opx ixuser name)
usr_pass=$(opx ixuser pass)
usr_tokn=$(opx ixuser tokn)

# ----- execution -----

echo "Remove old influx data"
cd /var/lib/influxdb
sudo rm -rf engine influxd.bolt
cd ~
sudo rm -rf .influxdbv2

echo "Restart influx service"
sudo systemctl restart influxdb.service
sleep 3

echo "Setup influx instance"
influx setup -u $own_name -p $own_pass -t $own_tokn -o org1 -b bkt1 -r 4h -f

echo "Create second organization"
influx org create -n org2

echo "Create influx users"
influx user create -n $mgr_name -p $mgr_pass -t $mgr_tokn -o org1
influx user create -n $usr_name -p $usr_pass -t $usr_tokn -o org1

echo "Create buckets for org1"
influx bucket create -n telegraf -o org1 -r 52w
influx bucket create -n weather  -o org1 -r 52w

echo "Create tokens for org1"
influx auth create -o org1 -d Org1AllAccess -u $mgr_name \
  --read-buckets \
  --read-checks \
  --read-dashboards \
  --read-dbrps \
  --read-notificationEndpoints \
  --read-notificationRules \
  --read-orgs \
  --read-tasks \
  --read-telegrafs \
  --read-user \
  --write-buckets \
  --write-checks \
  --write-dashboards \
  --write-dbrps \
  --write-notificationEndpoints \
  --write-notificationRules \
  --write-orgs \
  --write-tasks \
  --write-telegrafs \
  --write-user


